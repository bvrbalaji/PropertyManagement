// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  FLAT_OWNER
  TENANT
  MAINTENANCE_STAFF
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum VerificationType {
  EMAIL
  PHONE
}

enum OnboardingStatus {
  INQUIRY
  FORM_SUBMITTED
  INSPECTION_PENDING
  LEASE_SIGNED
  DEPOSIT_PENDING
  PARKING_ASSIGNED
  COMPLETED
  CANCELLED
}

enum OffboardingStatus {
  REQUESTED
  INSPECTION_SCHEDULED
  INSPECTION_COMPLETED
  SETTLEMENT_PENDING
  REFUND_PROCESSED
  COMPLETED
  CANCELLED
}

enum ParkingSlotStatus {
  AVAILABLE
  ASSIGNED
  RESERVED
  MAINTENANCE
}

enum VehicleType {
  TWO_WHEELER
  FOUR_WHEELER
  SUV
  COMMERCIAL
}

enum OwnershipVerificationStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum OwnershipTransferStatus {
  INITIATED
  PENDING_APPROVAL
  APPROVED
  REJECTED
  COMPLETED
}

enum CommunicationPreference {
  EMAIL
  SMS
  PHONE
  WHATSAPP
}

model User {
  id            String      @id @default(cuid())
  email         String      @unique
  phone         String?     @unique
  password      String
  fullName      String
  role          UserRole
  status        UserStatus  @default(ACTIVE)
  emailVerified Boolean     @default(false)
  phoneVerified Boolean     @default(false)
  mfaEnabled    Boolean     @default(false)
  mfaSecret     String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  lastLoginAt   DateTime?
  
  // Relations
  properties       Property[]
  ownedProperties    Property[]        @relation("PropertyOwner")
  tenantAssignments  TenantAssignment[]
  maintenanceRequests MaintenanceRequest[]
  sessions          Session[]
  verifications     Verification[]
  onboardings       TenantOnboarding[]  @relation("TenantOnboarding")
  offboardings      TenantOffboarding[] @relation("TenantOffboarding")
  ownerProfile      OwnerProfile?
  transfersInitiated OwnershipTransfer[] @relation("TransferInitiatedBy")
  transfersReceived OwnershipTransfer[] @relation("TransferredTo")
  
  @@index([email])
  @@index([phone])
  @@index([role])
  @@index([status])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  refreshToken String?  @unique
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Verification {
  id        String           @id @default(cuid())
  userId    String
  type      VerificationType
  code      String
  expiresAt DateTime
  verified  Boolean         @default(false)
  createdAt DateTime         @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([code])
  @@index([expiresAt])
}

model Property {
  id          String   @id @default(cuid())
  name        String
  address     String
  adminId     String
  ownerId     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  admin User @relation(fields: [adminId], references: [id])
  owner User? @relation("PropertyOwner", fields: [ownerId], references: [id])
  
  apartments        Apartment[]
  maintenanceRequests MaintenanceRequest[]
  onboardings       TenantOnboarding[]  @relation("PropertyOnboarding")
  offboardings      TenantOffboarding[] @relation("PropertyOffboarding")
  inspectionChecklists InspectionChecklist[]
  parkingSlots      ParkingSlot[]
  ownerProperties   OwnerProperty[]
  financialData     OwnerPropertyFinancial[]
  
  @@index([adminId])
  @@index([ownerId])
}

model Apartment {
  id         String   @id @default(cuid())
  propertyId String
  unitNumber String
  floor      Int?
  bedrooms   Int?
  bathrooms  Int?
  area       Float?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  tenantAssignments TenantAssignment[]
  maintenanceRequests MaintenanceRequest[]
  onboardings       TenantOnboarding[]  @relation("ApartmentOnboarding")
  offboardings      TenantOffboarding[] @relation("ApartmentOffboarding")
  
  @@index([propertyId])
  @@unique([propertyId, unitNumber])
}

model TenantAssignment {
  id          String   @id @default(cuid())
  apartmentId String
  tenantId    String
  startDate   DateTime
  endDate     DateTime?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  apartment Apartment @relation(fields: [apartmentId], references: [id])
  tenant    User      @relation(fields: [tenantId], references: [id])
  
  @@index([apartmentId])
  @@index([tenantId])
  @@index([isActive])
}

model MaintenanceRequest {
  id          String   @id @default(cuid())
  apartmentId String
  propertyId  String
  tenantId    String?
  staffId     String?
  title       String
  description String
  priority    String   @default("MEDIUM")
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  resolvedAt  DateTime?
  
  apartment Apartment @relation(fields: [apartmentId], references: [id])
  property  Property  @relation(fields: [propertyId], references: [id])
  staff     User?     @relation(fields: [staffId], references: [id])
  
  @@index([apartmentId])
  @@index([propertyId])
  @@index([tenantId])
  @@index([staffId])
  @@index([status])
  @@index([priority])
}

// Tenant Onboarding Models
model TenantOnboarding {
  id                    String            @id @default(cuid())
  tenantId              String
  apartmentId           String
  propertyId            String
  status                OnboardingStatus  @default(INQUIRY)
  moveInDate            DateTime
  securityDeposit       Float
  depositPaid           Float             @default(0)
  leaseAgreement        String?           // File path/URL
  leaseSignedAt         DateTime?
  parkingSlotId         String?
  inspectionChecklist   InspectionChecklist?
  onboardingCompletedAt DateTime?
  notificationSent      Boolean           @default(false)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  
  tenant User @relation("TenantOnboarding", fields: [tenantId], references: [id])
  apartment Apartment @relation("ApartmentOnboarding", fields: [apartmentId], references: [id])
  property Property @relation("PropertyOnboarding", fields: [propertyId], references: [id])
  parkingSlot ParkingSlot? @relation(fields: [parkingSlotId], references: [id])
  documents OnboardingDocument[]
  payments OnboardingPayment[]
  
  @@index([tenantId])
  @@index([apartmentId])
  @@index([propertyId])
  @@index([status])
  @@index([moveInDate])
}

model OnboardingDocument {
  id                String    @id @default(cuid())
  onboardingId      String
  documentType      String    // LEASE, VEHICLE_REG, ID_PROOF, etc.
  fileName          String
  fileUrl           String
  uploadedAt        DateTime  @default(now())
  encryptionKey     String?
  
  onboarding TenantOnboarding @relation(fields: [onboardingId], references: [id], onDelete: Cascade)
  
  @@index([onboardingId])
}

model OnboardingPayment {
  id                String    @id @default(cuid())
  onboardingId      String
  amount            Float
  paymentGateway    String    // STRIPE, RAZORPAY, etc.
  paymentId         String
  status            String    // PENDING, SUCCESS, FAILED
  transactionId     String?
  paidAt            DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  onboarding TenantOnboarding @relation(fields: [onboardingId], references: [id], onDelete: Cascade)
  
  @@index([onboardingId])
  @@index([paymentId])
}

model InspectionChecklist {
  id                String    @id @default(cuid())
  propertyId        String
  name              String
  isForOnboarding   Boolean   @default(true)
  items             ChecklistItem[]
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  property Property @relation(fields: [propertyId], references: [id])
  onboardings TenantOnboarding[]
  offboardings TenantOffboarding[]
  
  @@index([propertyId])
}

model ChecklistItem {
  id                String    @id @default(cuid())
  checklistId       String
  itemName          String
  category          String    // STRUCTURAL, APPLIANCES, PLUMBING, etc.
  createdAt         DateTime  @default(now())
  
  checklist InspectionChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  inspectionItems InspectionItem[]
  
  @@index([checklistId])
}

model InspectionItem {
  id                String    @id @default(cuid())
  inspectionId      String
  checklistItemId   String
  condition         String    // GOOD, FAIR, DAMAGED, MISSING
  notes             String?
  
  inspection Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  checklistItem ChecklistItem @relation(fields: [checklistItemId], references: [id])
  
  @@index([inspectionId])
}

model Inspection {
  id                String    @id @default(cuid())
  onboardingId      String?
  offboardingId     String?
  inspectionDate    DateTime
  inspectedBy       String
  photos            InspectionPhoto[]
  inspectionItems   InspectionItem[]
  damageAssessment  String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  onboarding TenantOnboarding? @relation(fields: [onboardingId], references: [id], onDelete: SetNull)
  offboarding TenantOffboarding? @relation(fields: [offboardingId], references: [id], onDelete: SetNull)
  
  @@index([onboardingId])
  @@index([offboardingId])
}

model InspectionPhoto {
  id                String    @id @default(cuid())
  inspectionId      String
  photoUrl          String
  beforePhoto       String?   // For damage comparison
  afterPhoto        String?
  uploadedAt        DateTime  @default(now())
  
  inspection Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  
  @@index([inspectionId])
}

// Parking Management
model ParkingSlot {
  id                String            @id @default(cuid())
  propertyId        String
  slotNumber        String
  floor             String?
  vehicleType       VehicleType
  status            ParkingSlotStatus @default(AVAILABLE)
  assignedToId      String?
  assignedAt        DateTime?
  releasedAt        DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  property Property @relation(fields: [propertyId], references: [id])
  assignedTo TenantOnboarding? @relation(fields: [assignedToId], references: [id])
  
  @@index([propertyId])
  @@index([status])
  @@index([assignedToId])
  @@unique([propertyId, slotNumber])
}

// Tenant Offboarding Models
model TenantOffboarding {
  id                    String            @id @default(cuid())
  tenantId              String
  apartmentId           String
  propertyId            String
  onboardingId          String
  status                OffboardingStatus @default(REQUESTED)
  moveOutDate           DateTime?
  noticeDate            DateTime          @default(now())
  inspectionChecklist   InspectionChecklist?
  inspection            Inspection?
  finalSettlement       FinalSettlement?
  clearanceCertificate  String?           // File path/URL
  offboardingCompletedAt DateTime?
  notificationSent      Boolean           @default(false)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  
  tenant User @relation("TenantOffboarding", fields: [tenantId], references: [id])
  apartment Apartment @relation("ApartmentOffboarding", fields: [apartmentId], references: [id])
  property Property @relation("PropertyOffboarding", fields: [propertyId], references: [id])
  onboarding TenantOnboarding @relation(fields: [onboardingId], references: [id])
  documents OffboardingDocument[]
  
  @@index([tenantId])
  @@index([apartmentId])
  @@index([propertyId])
  @@index([status])
  @@index([moveOutDate])
}

model OffboardingDocument {
  id                String    @id @default(cuid())
  offboardingId     String
  documentType      String    // FINAL_BILL, CLEARANCE, etc.
  fileName          String
  fileUrl           String
  uploadedAt        DateTime  @default(now())
  
  offboarding TenantOffboarding @relation(fields: [offboardingId], references: [id], onDelete: Cascade)
  
  @@index([offboardingId])
}

model FinalSettlement {
  id                String    @id @default(cuid())
  offboardingId     String    @unique
  securityDeposit   Float
  damageCharges     Float     @default(0)
  pendingDues       Float     @default(0)
  refundAmount      Float
  refundDate        DateTime?
  refundStatus      String    @default("PENDING") // PENDING, PROCESSED, COMPLETED
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  offboarding TenantOffboarding @relation(fields: [offboardingId], references: [id], onDelete: Cascade)
  
  @@index([offboardingId])
}

// ===== FLAT OWNER DETAILS MODELS =====

model OwnerProfile {
  id                    String    @id @default(cuid())
  userId                String    @unique
  secondaryEmail        String?
  secondaryPhone        String?
  address               String?
  city                  String?
  state                 String?
  zipCode               String?
  country               String?
  businessName          String?
  businessRegistration  String?
  panNumber             String?
  gstin                 String?
  bankAccountNumber     String?
  bankIfscCode          String?
  bankAccountName       String?
  emergencyContactName  String?
  emergencyContactPhone String?
  emergencyContactEmail String?
  communicationPreference CommunicationPreference @default(EMAIL)
  profileCompleteness   Int       @default(0) // 0-100
  verificationStatus    OwnershipVerificationStatus @default(PENDING)
  verifiedAt            DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  properties OwnerProperty[]
  verificationDocuments OwnershipVerificationDocument[]
  coOwners CoOwnerRelation[] @relation("OwnerProfile")
  coOwnerOf CoOwnerRelation[] @relation("CoOwnerProfile")
  transfers OwnershipTransfer[] @relation("InitiatedBy")
  transfersTo OwnershipTransfer[] @relation("TransferredTo")
  
  @@index([userId])
  @@index([verificationStatus])
}

model OwnerProperty {
  id              String    @id @default(cuid())
  ownerProfileId  String
  propertyId      String
  ownershipPercentage Float @default(100) // For co-ownership
  ownershipStartDate DateTime
  ownershipEndDate DateTime?
  documentUrl     String?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  ownerProfile OwnerProfile @relation(fields: [ownerProfileId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  @@unique([ownerProfileId, propertyId])
  @@index([ownerProfileId])
  @@index([propertyId])
}

model OwnershipVerificationDocument {
  id                String    @id @default(cuid())
  ownerProfileId    String
  documentType      String    // PROPERTY_DEED, RENT_AGREEMENT, ELECTRICITY_BILL, etc.
  fileName          String
  fileUrl           String
  encryptionKey     String
  uploadedAt        DateTime  @default(now())
  expiryDate        DateTime?
  verificationStatus OwnershipVerificationStatus @default(PENDING)
  verifiedAt        DateTime?
  verifiedBy        String?   // Admin ID
  notes             String?
  
  ownerProfile OwnerProfile @relation(fields: [ownerProfileId], references: [id], onDelete: Cascade)
  
  @@index([ownerProfileId])
  @@index([verificationStatus])
}

model CoOwnerRelation {
  id              String    @id @default(cuid())
  ownerProfileId  String
  coOwnerProfileId String
  ownershipPercentage Float @default(50)
  relationshipType String  // SPOUSE, PARENT, CHILD, BUSINESS_PARTNER, etc.
  legalDocumentUrl String?
  approvalStatus  String    @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  ownerProfile OwnerProfile @relation("OwnerProfile", fields: [ownerProfileId], references: [id], onDelete: Cascade)
  coOwnerProfile OwnerProfile @relation("CoOwnerProfile", fields: [coOwnerProfileId], references: [id], onDelete: Cascade)
  
  @@unique([ownerProfileId, coOwnerProfileId])
  @@index([ownerProfileId])
  @@index([coOwnerProfileId])
}

model OwnershipTransfer {
  id                String    @id @default(cuid())
  initiatedByUserId String
  transferredToUserId String?
  propertyId        String
  ownershipPercentage Float @default(100)
  transferDate      DateTime
  reason            String?
  legalDocumentUrl  String?
  status            OwnershipTransferStatus @default(INITIATED)
  completedAt       DateTime?
  approvedBy        String?   // Admin ID
  rejectionReason   String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  initiatedByUser User @relation("TransferInitiatedBy", fields: [initiatedByUserId], references: [id])
  transferredToUser User? @relation("TransferredTo", fields: [transferredToUserId], references: [id])
  initiatorProfile OwnerProfile @relation("InitiatedBy", fields: [initiatedByUserId], references: [userId], onDelete: Cascade)
  recipientProfile OwnerProfile? @relation("TransferredTo", fields: [transferredToUserId], references: [userId], onDelete: Cascade)
  
  @@index([initiatedByUserId])
  @@index([transferredToUserId])
  @@index([propertyId])
  @@index([status])
}

model OwnerPropertyFinancial {
  id              String    @id @default(cuid())
  ownerProfileId  String
  propertyId      String
  rentalIncome    Float     @default(0)
  maintenanceFees Float     @default(0)
  propertyTax     Float     @default(0)
  insurance       Float     @default(0)
  utilities       Float     @default(0)
  otherExpenses   Float     @default(0)
  netIncome       Float     @default(0) // rentalIncome - all expenses
  totalTenants    Int       @default(0)
  occupancyRate   Float     @default(0) // 0-100
  lastUpdated     DateTime  @updatedAt
  createdAt       DateTime  @default(now())
  
  ownerProfile OwnerProfile @relation(fields: [ownerProfileId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  @@unique([ownerProfileId, propertyId])
  @@index([ownerProfileId])
  @@index([propertyId])
}

model OwnerCommunication {
  id              String    @id @default(cuid())
  ownerProfileId  String
  communicationType String  // ANNOUNCEMENT, MAINTENANCE, PAYMENT_REMINDER, etc.
  subject         String
  message         String
  sentAt          DateTime
  readAt          DateTime?
  channel         CommunicationPreference // EMAIL, SMS, PHONE, WHATSAPP
  relatedPropertyId String?
  createdAt       DateTime  @default(now())
  
  ownerProfile OwnerProfile @relation(fields: [ownerProfileId], references: [id], onDelete: Cascade)
  
  @@index([ownerProfileId])
  @@index([sentAt])
  @@index([readAt])
}
