// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  FLAT_OWNER
  TENANT
  MAINTENANCE_STAFF
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum VerificationType {
  EMAIL
  PHONE
}

enum OnboardingStatus {
  INQUIRY
  FORM_SUBMITTED
  INSPECTION_PENDING
  LEASE_SIGNED
  DEPOSIT_PENDING
  PARKING_ASSIGNED
  COMPLETED
  CANCELLED
}

enum OffboardingStatus {
  REQUESTED
  INSPECTION_SCHEDULED
  INSPECTION_COMPLETED
  SETTLEMENT_PENDING
  REFUND_PROCESSED
  COMPLETED
  CANCELLED
}

enum ParkingSlotStatus {
  AVAILABLE
  ASSIGNED
  RESERVED
  MAINTENANCE
}

enum VehicleType {
  TWO_WHEELER
  FOUR_WHEELER
  SUV
  COMMERCIAL
}

enum OwnershipVerificationStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum OwnershipTransferStatus {
  INITIATED
  PENDING_APPROVAL
  APPROVED
  REJECTED
  COMPLETED
}

enum CommunicationPreference {
  EMAIL
  SMS
  PHONE
  WHATSAPP
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
  IN_APP
  WHATSAPP
}

enum NotificationType {
  INVOICE_CREATED
  INVOICE_SENT
  PAYMENT_REMINDER
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  OVERDUE_NOTICE
  MAINTENANCE_ALERT
  BROADCAST
  ANNOUNCEMENT
  EMERGENCY
  TARGETED_MESSAGE
  LATE_FEE_NOTICE
  SYSTEM_NOTIFICATION
}

enum NotificationStatus {
  DRAFT
  SCHEDULED
  QUEUED
  SENT
  DELIVERED
  FAILED
  BOUNCED
}

enum NotificationDeliveryStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
  OPENED
  CLICKED
}

model User {
  id            String      @id @default(cuid())
  email         String      @unique
  phone         String?     @unique
  password      String
  fullName      String
  role          UserRole
  status        UserStatus  @default(ACTIVE)
  emailVerified Boolean     @default(false)
  phoneVerified Boolean     @default(false)
  mfaEnabled    Boolean     @default(false)
  mfaSecret     String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  lastLoginAt   DateTime?
  
  // Relations
  properties       Property[]
  ownedProperties    Property[]        @relation("PropertyOwner")
  tenantAssignments  TenantAssignment[]
  maintenanceRequests MaintenanceRequest[]
  sessions          Session[]
  verifications     Verification[]
  onboardings       TenantOnboarding[]  @relation("TenantOnboarding")
  offboardings      TenantOffboarding[] @relation("TenantOffboarding")
  ownerProfile      OwnerProfile?
  transfersInitiated OwnershipTransfer[] @relation("TransferInitiatedBy")
  transfersReceived OwnershipTransfer[] @relation("TransferredTo")
  
  // Financial relations (for tenants)
  rentInvoices      RentInvoice[]
  maintenanceInvoices MaintenanceInvoice[]
  payments          Payment[]
  paymentReminders  PaymentReminder[]
  lateFees          LateFee[]
  
  // Notification relations
  notificationPreference NotificationPreference?
  notificationsCreated Notification[]
  notificationDeliveries NotificationDelivery[]
  inAppNotifications InAppNotification[]
  pushDeviceTokens  PushDeviceToken[]
  broadcastMessagesCreated BroadcastMessage[]
  notificationTemplatesCreated NotificationTemplate[] @relation("TemplateCreator")
  notificationTemplatesUpdated NotificationTemplate[] @relation("TemplateUpdater")
  notificationSchedulesCreated NotificationSchedule[]
  
  @@index([email])
  @@index([phone])
  @@index([role])
  @@index([status])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  refreshToken String?  @unique
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Verification {
  id        String           @id @default(cuid())
  userId    String
  type      VerificationType
  code      String
  expiresAt DateTime
  verified  Boolean         @default(false)
  createdAt DateTime         @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([code])
  @@index([expiresAt])
}

model Property {
  id          String   @id @default(cuid())
  name        String
  address     String
  adminId     String
  ownerId     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  admin User @relation(fields: [adminId], references: [id])
  owner User? @relation("PropertyOwner", fields: [ownerId], references: [id])
  
  apartments        Apartment[]
  maintenanceRequests MaintenanceRequest[]
  onboardings       TenantOnboarding[]  @relation("PropertyOnboarding")
  offboardings      TenantOffboarding[] @relation("PropertyOffboarding")
  inspectionChecklists InspectionChecklist[]
  parkingSlots      ParkingSlot[]
  ownerProperties   OwnerProperty[]
  financialData     OwnerPropertyFinancial[]
  
  // Financial relations
  rentInvoices      RentInvoice[] @relation("RentInvoices")
  maintenanceInvoices MaintenanceInvoice[] @relation("MaintenanceInvoices")
  payments          Payment[] @relation("Payments")
  rentConfigs       RentConfig[]
  maintenanceFeeConfigs MaintenanceFeeConfig[]
  
  // Notification relations
  notificationTemplates NotificationTemplate[]
  notifications     Notification[]
  broadcastMessages BroadcastMessage[]
  notificationSchedules NotificationSchedule[]
  
  @@index([adminId])
  @@index([ownerId])
}

model Apartment {
  id         String   @id @default(cuid())
  propertyId String
  unitNumber String
  floor      Int?
  bedrooms   Int?
  bathrooms  Int?
  area       Float?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  tenantAssignments TenantAssignment[]
  maintenanceRequests MaintenanceRequest[]
  onboardings       TenantOnboarding[]  @relation("ApartmentOnboarding")
  offboardings      TenantOffboarding[] @relation("ApartmentOffboarding")
  
  // Financial relations
  rentInvoices      RentInvoice[]
  maintenanceInvoices MaintenanceInvoice[]
  payments          Payment[]
  rentConfigs       RentConfig[]
  maintenanceFeeConfigs MaintenanceFeeConfig[]
  
  @@index([propertyId])
  @@unique([propertyId, unitNumber])
}

model TenantAssignment {
  id          String   @id @default(cuid())
  apartmentId String
  tenantId    String
  startDate   DateTime
  endDate     DateTime?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  apartment Apartment @relation(fields: [apartmentId], references: [id])
  tenant    User      @relation(fields: [tenantId], references: [id])
  
  @@index([apartmentId])
  @@index([tenantId])
  @@index([isActive])
}

model MaintenanceRequest {
  id          String   @id @default(cuid())
  apartmentId String
  propertyId  String
  tenantId    String?
  staffId     String?
  title       String
  description String
  priority    String   @default("MEDIUM")
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  resolvedAt  DateTime?
  
  apartment Apartment @relation(fields: [apartmentId], references: [id])
  property  Property  @relation(fields: [propertyId], references: [id])
  staff     User?     @relation(fields: [staffId], references: [id])
  
  @@index([apartmentId])
  @@index([propertyId])
  @@index([tenantId])
  @@index([staffId])
  @@index([status])
  @@index([priority])
}

// Tenant Onboarding Models
model TenantOnboarding {
  id                    String            @id @default(cuid())
  tenantId              String
  apartmentId           String
  propertyId            String
  status                OnboardingStatus  @default(INQUIRY)
  moveInDate            DateTime
  securityDeposit       Float
  depositPaid           Float             @default(0)
  leaseAgreement        String?           // File path/URL
  leaseSignedAt         DateTime?
  parkingSlotId         String?
  inspectionChecklist   InspectionChecklist?
  onboardingCompletedAt DateTime?
  notificationSent      Boolean           @default(false)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  
  tenant User @relation("TenantOnboarding", fields: [tenantId], references: [id])
  apartment Apartment @relation("ApartmentOnboarding", fields: [apartmentId], references: [id])
  property Property @relation("PropertyOnboarding", fields: [propertyId], references: [id])
  parkingSlot ParkingSlot? @relation(fields: [parkingSlotId], references: [id])
  documents OnboardingDocument[]
  payments OnboardingPayment[]
  
  @@index([tenantId])
  @@index([apartmentId])
  @@index([propertyId])
  @@index([status])
  @@index([moveInDate])
}

model OnboardingDocument {
  id                String    @id @default(cuid())
  onboardingId      String
  documentType      String    // LEASE, VEHICLE_REG, ID_PROOF, etc.
  fileName          String
  fileUrl           String
  uploadedAt        DateTime  @default(now())
  encryptionKey     String?
  
  onboarding TenantOnboarding @relation(fields: [onboardingId], references: [id], onDelete: Cascade)
  
  @@index([onboardingId])
}

model OnboardingPayment {
  id                String    @id @default(cuid())
  onboardingId      String
  amount            Float
  paymentGateway    String    // STRIPE, RAZORPAY, etc.
  paymentId         String
  status            String    // PENDING, SUCCESS, FAILED
  transactionId     String?
  paidAt            DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  onboarding TenantOnboarding @relation(fields: [onboardingId], references: [id], onDelete: Cascade)
  
  @@index([onboardingId])
  @@index([paymentId])
}

model InspectionChecklist {
  id                String    @id @default(cuid())
  propertyId        String
  name              String
  isForOnboarding   Boolean   @default(true)
  items             ChecklistItem[]
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  property Property @relation(fields: [propertyId], references: [id])
  onboardings TenantOnboarding[]
  offboardings TenantOffboarding[]
  
  @@index([propertyId])
}

model ChecklistItem {
  id                String    @id @default(cuid())
  checklistId       String
  itemName          String
  category          String    // STRUCTURAL, APPLIANCES, PLUMBING, etc.
  createdAt         DateTime  @default(now())
  
  checklist InspectionChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  inspectionItems InspectionItem[]
  
  @@index([checklistId])
}

model InspectionItem {
  id                String    @id @default(cuid())
  inspectionId      String
  checklistItemId   String
  condition         String    // GOOD, FAIR, DAMAGED, MISSING
  notes             String?
  
  inspection Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  checklistItem ChecklistItem @relation(fields: [checklistItemId], references: [id])
  
  @@index([inspectionId])
}

model Inspection {
  id                String    @id @default(cuid())
  onboardingId      String?
  offboardingId     String?
  inspectionDate    DateTime
  inspectedBy       String
  photos            InspectionPhoto[]
  inspectionItems   InspectionItem[]
  damageAssessment  String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  onboarding TenantOnboarding? @relation(fields: [onboardingId], references: [id], onDelete: SetNull)
  offboarding TenantOffboarding? @relation(fields: [offboardingId], references: [id], onDelete: SetNull)
  
  @@index([onboardingId])
  @@index([offboardingId])
}

model InspectionPhoto {
  id                String    @id @default(cuid())
  inspectionId      String
  photoUrl          String
  beforePhoto       String?   // For damage comparison
  afterPhoto        String?
  uploadedAt        DateTime  @default(now())
  
  inspection Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  
  @@index([inspectionId])
}

// Parking Management
model ParkingSlot {
  id                String            @id @default(cuid())
  propertyId        String
  slotNumber        String
  floor             String?
  vehicleType       VehicleType
  status            ParkingSlotStatus @default(AVAILABLE)
  assignedToId      String?
  assignedAt        DateTime?
  releasedAt        DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  property Property @relation(fields: [propertyId], references: [id])
  assignedTo TenantOnboarding? @relation(fields: [assignedToId], references: [id])
  
  @@index([propertyId])
  @@index([status])
  @@index([assignedToId])
  @@unique([propertyId, slotNumber])
}

// Tenant Offboarding Models
model TenantOffboarding {
  id                    String            @id @default(cuid())
  tenantId              String
  apartmentId           String
  propertyId            String
  onboardingId          String
  status                OffboardingStatus @default(REQUESTED)
  moveOutDate           DateTime?
  noticeDate            DateTime          @default(now())
  inspectionChecklist   InspectionChecklist?
  inspection            Inspection?
  finalSettlement       FinalSettlement?
  clearanceCertificate  String?           // File path/URL
  offboardingCompletedAt DateTime?
  notificationSent      Boolean           @default(false)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  
  tenant User @relation("TenantOffboarding", fields: [tenantId], references: [id])
  apartment Apartment @relation("ApartmentOffboarding", fields: [apartmentId], references: [id])
  property Property @relation("PropertyOffboarding", fields: [propertyId], references: [id])
  onboarding TenantOnboarding @relation(fields: [onboardingId], references: [id])
  documents OffboardingDocument[]
  
  @@index([tenantId])
  @@index([apartmentId])
  @@index([propertyId])
  @@index([status])
  @@index([moveOutDate])
}

model OffboardingDocument {
  id                String    @id @default(cuid())
  offboardingId     String
  documentType      String    // FINAL_BILL, CLEARANCE, etc.
  fileName          String
  fileUrl           String
  uploadedAt        DateTime  @default(now())
  
  offboarding TenantOffboarding @relation(fields: [offboardingId], references: [id], onDelete: Cascade)
  
  @@index([offboardingId])
}

model FinalSettlement {
  id                String    @id @default(cuid())
  offboardingId     String    @unique
  securityDeposit   Float
  damageCharges     Float     @default(0)
  pendingDues       Float     @default(0)
  refundAmount      Float
  refundDate        DateTime?
  refundStatus      String    @default("PENDING") // PENDING, PROCESSED, COMPLETED
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  offboarding TenantOffboarding @relation(fields: [offboardingId], references: [id], onDelete: Cascade)
  
  @@index([offboardingId])
}

// ===== FLAT OWNER DETAILS MODELS =====

model OwnerProfile {
  id                    String    @id @default(cuid())
  userId                String    @unique
  secondaryEmail        String?
  secondaryPhone        String?
  address               String?
  city                  String?
  state                 String?
  zipCode               String?
  country               String?
  businessName          String?
  businessRegistration  String?
  panNumber             String?
  gstin                 String?
  bankAccountNumber     String?
  bankIfscCode          String?
  bankAccountName       String?
  emergencyContactName  String?
  emergencyContactPhone String?
  emergencyContactEmail String?
  communicationPreference CommunicationPreference @default(EMAIL)
  profileCompleteness   Int       @default(0) // 0-100
  verificationStatus    OwnershipVerificationStatus @default(PENDING)
  verifiedAt            DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  properties OwnerProperty[]
  verificationDocuments OwnershipVerificationDocument[]
  coOwners CoOwnerRelation[] @relation("OwnerProfile")
  coOwnerOf CoOwnerRelation[] @relation("CoOwnerProfile")
  transfers OwnershipTransfer[] @relation("InitiatedBy")
  transfersTo OwnershipTransfer[] @relation("TransferredTo")
  
  @@index([userId])
  @@index([verificationStatus])
}

model OwnerProperty {
  id              String    @id @default(cuid())
  ownerProfileId  String
  propertyId      String
  ownershipPercentage Float @default(100) // For co-ownership
  ownershipStartDate DateTime
  ownershipEndDate DateTime?
  documentUrl     String?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  ownerProfile OwnerProfile @relation(fields: [ownerProfileId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  @@unique([ownerProfileId, propertyId])
  @@index([ownerProfileId])
  @@index([propertyId])
}

model OwnershipVerificationDocument {
  id                String    @id @default(cuid())
  ownerProfileId    String
  documentType      String    // PROPERTY_DEED, RENT_AGREEMENT, ELECTRICITY_BILL, etc.
  fileName          String
  fileUrl           String
  encryptionKey     String
  uploadedAt        DateTime  @default(now())
  expiryDate        DateTime?
  verificationStatus OwnershipVerificationStatus @default(PENDING)
  verifiedAt        DateTime?
  verifiedBy        String?   // Admin ID
  notes             String?
  
  ownerProfile OwnerProfile @relation(fields: [ownerProfileId], references: [id], onDelete: Cascade)
  
  @@index([ownerProfileId])
  @@index([verificationStatus])
}

model CoOwnerRelation {
  id              String    @id @default(cuid())
  ownerProfileId  String
  coOwnerProfileId String
  ownershipPercentage Float @default(50)
  relationshipType String  // SPOUSE, PARENT, CHILD, BUSINESS_PARTNER, etc.
  legalDocumentUrl String?
  approvalStatus  String    @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  ownerProfile OwnerProfile @relation("OwnerProfile", fields: [ownerProfileId], references: [id], onDelete: Cascade)
  coOwnerProfile OwnerProfile @relation("CoOwnerProfile", fields: [coOwnerProfileId], references: [id], onDelete: Cascade)
  
  @@unique([ownerProfileId, coOwnerProfileId])
  @@index([ownerProfileId])
  @@index([coOwnerProfileId])
}

model OwnershipTransfer {
  id                String    @id @default(cuid())
  initiatedByUserId String
  transferredToUserId String?
  propertyId        String
  ownershipPercentage Float @default(100)
  transferDate      DateTime
  reason            String?
  legalDocumentUrl  String?
  status            OwnershipTransferStatus @default(INITIATED)
  completedAt       DateTime?
  approvedBy        String?   // Admin ID
  rejectionReason   String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  initiatedByUser User @relation("TransferInitiatedBy", fields: [initiatedByUserId], references: [id])
  transferredToUser User? @relation("TransferredTo", fields: [transferredToUserId], references: [id])
  initiatorProfile OwnerProfile @relation("InitiatedBy", fields: [initiatedByUserId], references: [userId], onDelete: Cascade)
  recipientProfile OwnerProfile? @relation("TransferredTo", fields: [transferredToUserId], references: [userId], onDelete: Cascade)
  
  @@index([initiatedByUserId])
  @@index([transferredToUserId])
  @@index([propertyId])
  @@index([status])
}

model OwnerPropertyFinancial {
  id              String    @id @default(cuid())
  ownerProfileId  String
  propertyId      String
  rentalIncome    Float     @default(0)
  maintenanceFees Float     @default(0)
  propertyTax     Float     @default(0)
  insurance       Float     @default(0)
  utilities       Float     @default(0)
  otherExpenses   Float     @default(0)
  netIncome       Float     @default(0) // rentalIncome - all expenses
  totalTenants    Int       @default(0)
  occupancyRate   Float     @default(0) // 0-100
  lastUpdated     DateTime  @updatedAt
  createdAt       DateTime  @default(now())
  
  ownerProfile OwnerProfile @relation(fields: [ownerProfileId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  @@unique([ownerProfileId, propertyId])
  @@index([ownerProfileId])
  @@index([propertyId])
}

model OwnerCommunication {
  id              String    @id @default(cuid())
  ownerProfileId  String
  communicationType String  // ANNOUNCEMENT, MAINTENANCE, PAYMENT_REMINDER, etc.
  subject         String
  message         String
  sentAt          DateTime
  readAt          DateTime?
  channel         CommunicationPreference // EMAIL, SMS, PHONE, WHATSAPP
  relatedPropertyId String?
  createdAt       DateTime  @default(now())
  
  ownerProfile OwnerProfile @relation(fields: [ownerProfileId], references: [id], onDelete: Cascade)
  
  @@index([ownerProfileId])
  @@index([sentAt])
  @@index([readAt])
}

// ==================== FINANCIAL MANAGEMENT ====================

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PARTIALLY_PAID
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  UPI
  NET_BANKING
  CREDIT_CARD
  DEBIT_CARD
  WALLET
  CASH
  CHEQUE
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
  CANCELLED
}

enum ReminderType {
  INVOICE_SENT
  DUE_DATE_REMINDER
  OVERDUE_1
  OVERDUE_2
  OVERDUE_3
}

model RentInvoice {
  id                String    @id @default(cuid())
  tenantId          String
  propertyId        String
  apartmentId       String
  invoiceNumber     String    @unique
  invoiceDate       DateTime  @default(now())
  dueDate           DateTime
  rentAmount        Float
  lateFeeAmount     Float     @default(0)
  totalAmount       Float
  paidAmount        Float     @default(0)
  balanceAmount     Float
  status            InvoiceStatus @default(SENT)
  description       String?
  notes             String?
  
  // Payment tracking
  firstPaymentDate  DateTime?
  lastPaymentDate   DateTime?
  
  // Late fees
  isOverdue         Boolean   @default(false)
  overdueDate       DateTime?
  daysOverdue       Int       @default(0)
  
  // Reminders sent
  dueReminder       Boolean   @default(false)
  overdueReminder   Boolean   @default(false)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  tenant            User      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  property          Property  @relation("RentInvoices", fields: [propertyId], references: [id], onDelete: Cascade)
  apartment         Apartment @relation(fields: [apartmentId], references: [id], onDelete: Cascade)
  payments          Payment[]
  reminders         PaymentReminder[]
  lateFees          LateFee[]
  receipts          PaymentReceipt[]
  
  @@unique([tenantId, propertyId, apartmentId, invoiceDate])
  @@index([tenantId])
  @@index([propertyId])
  @@index([apartmentId])
  @@index([status])
  @@index([dueDate])
  @@index([isOverdue])
  @@index([createdAt])
}

model MaintenanceInvoice {
  id                String    @id @default(cuid())
  tenantId          String
  propertyId        String
  apartmentId       String
  invoiceNumber     String    @unique
  invoiceDate       DateTime  @default(now())
  dueDate           DateTime
  maintenanceAmount Float
  waterCharges      Float     @default(0)
  securityCharges   Float     @default(0)
  cleaningCharges   Float     @default(0)
  otherCharges      Float     @default(0)
  totalAmount       Float
  paidAmount        Float     @default(0)
  balanceAmount     Float
  status            InvoiceStatus @default(SENT)
  description       String?
  notes             String?
  
  // Combined with rent
  combinedWithRent  Boolean   @default(false)
  rentInvoiceId     String?
  
  // Payment tracking
  firstPaymentDate  DateTime?
  lastPaymentDate   DateTime?
  
  // Late fees
  isOverdue         Boolean   @default(false)
  overdueDate       DateTime?
  daysOverdue       Int       @default(0)
  
  // Reminders sent
  dueReminder       Boolean   @default(false)
  overdueReminder   Boolean   @default(false)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  tenant            User      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  property          Property  @relation("MaintenanceInvoices", fields: [propertyId], references: [id], onDelete: Cascade)
  apartment         Apartment @relation(fields: [apartmentId], references: [id], onDelete: Cascade)
  payments          Payment[]
  reminders         PaymentReminder[]
  lateFees          LateFee[]
  receipts          PaymentReceipt[]
  
  @@unique([tenantId, propertyId, apartmentId, invoiceDate])
  @@index([tenantId])
  @@index([propertyId])
  @@index([apartmentId])
  @@index([status])
  @@index([dueDate])
  @@index([isOverdue])
  @@index([createdAt])
}

model Payment {
  id                String    @id @default(cuid())
  tenantId          String
  propertyId        String
  apartmentId       String
  
  // Payment details
  rentInvoiceId     String?
  maintenanceInvoiceId String?
  paymentAmount     Float
  paymentDate       DateTime  @default(now())
  paymentMethod     PaymentMethod
  status            PaymentStatus @default(PENDING)
  
  // Payment gateway
  transactionId     String?   @unique
  gatewayReference  String?
  gatewayResponse   Json?
  
  // Payment gateway info
  paymentGateway    String    // "razorpay" | "stripe"
  
  // Refund tracking
  refundAmount      Float     @default(0)
  refundDate        DateTime?
  refundReason      String?
  
  notes             String?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  tenant            User      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  property          Property  @relation("Payments", fields: [propertyId], references: [id], onDelete: Cascade)
  apartment         Apartment @relation(fields: [apartmentId], references: [id], onDelete: Cascade)
  rentInvoice       RentInvoice? @relation(fields: [rentInvoiceId], references: [id], onDelete: SetNull)
  maintenanceInvoice MaintenanceInvoice? @relation(fields: [maintenanceInvoiceId], references: [id], onDelete: SetNull)
  receipt           PaymentReceipt?
  
  @@index([tenantId])
  @@index([propertyId])
  @@index([apartmentId])
  @@index([status])
  @@index([paymentDate])
  @@index([paymentGateway])
  @@index([rentInvoiceId])
  @@index([maintenanceInvoiceId])
}

model PaymentReceipt {
  id                String    @id @default(cuid())
  paymentId         String    @unique
  rentInvoiceId     String?
  maintenanceInvoiceId String?
  receiptNumber     String    @unique
  receiptDate       DateTime  @default(now())
  
  // Receipt details
  tenantName        String
  tenantEmail       String
  paymentAmount     Float
  paymentMethod     String
  transactionId     String?
  
  // Document
  pdfUrl            String?
  emailSentAt       DateTime?
  emailStatus       String?   // "sent" | "failed" | "bounced"
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  payment           Payment   @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  rentInvoice       RentInvoice? @relation(fields: [rentInvoiceId], references: [id], onDelete: SetNull)
  maintenanceInvoice MaintenanceInvoice? @relation(fields: [maintenanceInvoiceId], references: [id], onDelete: SetNull)
  
  @@index([paymentId])
  @@index([rentInvoiceId])
  @@index([maintenanceInvoiceId])
  @@index([emailSentAt])
  @@index([receiptDate])
}

model PaymentReminder {
  id                String    @id @default(cuid())
  tenantId          String
  rentInvoiceId     String?
  maintenanceInvoiceId String?
  
  reminderType      ReminderType
  scheduledDate     DateTime
  sentDate          DateTime?
  
  // Reminder content
  subject           String
  message           String
  channel           String    // "email" | "sms" | "whatsapp"
  
  // Status
  status            String    @default("pending") // "pending" | "sent" | "failed"
  retryCount        Int       @default(0)
  maxRetries        Int       @default(3)
  
  // Response tracking
  openedAt          DateTime?
  clickedAt         DateTime?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  tenant            User      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  rentInvoice       RentInvoice? @relation(fields: [rentInvoiceId], references: [id], onDelete: Cascade)
  maintenanceInvoice MaintenanceInvoice? @relation(fields: [maintenanceInvoiceId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([status])
  @@index([scheduledDate])
  @@index([sentDate])
}

model LateFee {
  id                String    @id @default(cuid())
  tenantId          String
  rentInvoiceId     String?
  maintenanceInvoiceId String?
  
  // Late fee calculation
  invoiceDate       DateTime
  dueDate           DateTime
  paymentDueDate    DateTime
  
  daysOverdue       Int
  lateFeeAmount     Float
  lateFeePercent    Float    // percentage of invoice amount
  
  // Fee rules
  calculationMethod String    // "flat" | "percent_per_day" | "percent_per_month"
  maxLateFee        Float?
  
  status            String    @default("active") // "active" | "waived" | "paid"
  waivedAt          DateTime?
  waivedBy          String?
  waiverReason      String?
  
  paidAmount        Float     @default(0)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  tenant            User      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  rentInvoice       RentInvoice? @relation(fields: [rentInvoiceId], references: [id], onDelete: Cascade)
  maintenanceInvoice MaintenanceInvoice? @relation(fields: [maintenanceInvoiceId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([status])
  @@index([createdAt])
}

model MaintenanceFeeConfig {
  id                String    @id @default(cuid())
  propertyId        String
  apartmentId       String?   // null = apply to all in property
  
  // Base amounts
  maintenanceAmount Float
  waterCharges      Float     @default(0)
  securityCharges   Float     @default(0)
  cleaningCharges   Float     @default(0)
  otherCharges      Float     @default(0)
  
  // Configuration
  feeType           String    @default("fixed") // "fixed" | "variable"
  billingCycle      String    @default("monthly") // "monthly" | "quarterly" | "yearly"
  effectiveFrom     DateTime
  effectiveTo       DateTime?
  
  // Payment settings
  dueDate           Int       // day of month (1-31)
  gracePeriod       Int       @default(5) // days after due date
  
  // Escalation
  annualIncrease    Float?    // percentage increase per year
  lastIncreaseDate  DateTime?
  nextIncreaseDate  DateTime?
  
  // Exemptions
  isActive          Boolean   @default(true)
  exemptVacant      Boolean   @default(true)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  property          Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  apartment         Apartment? @relation(fields: [apartmentId], references: [id], onDelete: Cascade)
  
  @@unique([propertyId, apartmentId, effectiveFrom])
  @@index([propertyId])
  @@index([apartmentId])
  @@index([isActive])
}

model RentConfig {
  id                String    @id @default(cuid())
  propertyId        String
  apartmentId       String?   // null = apply to all in property
  
  // Rent amount
  rentAmount        Float
  
  // Configuration
  billingCycle      String    @default("monthly") // "monthly" | "quarterly" | "yearly"
  dueDate           Int       // day of month (1-31)
  gracePeriod       Int       @default(5) // days after due date
  
  // Late fee rules
  lateFeeType       String    @default("percent") // "flat" | "percent"
  lateFeeValue      Float     // amount or percentage
  lateFeeMaxPercent Float?    // max late fee as % of rent
  calculateFrom     String    @default("due_date") // "due_date" | "rent_date"
  
  // Escalation
  annualIncrease    Float?    // percentage increase per year
  lastIncreaseDate  DateTime?
  nextIncreaseDate  DateTime?
  
  // Payment settings
  multiplePayments  Boolean   @default(true) // allow partial payments
  
  effectiveFrom     DateTime
  effectiveTo       DateTime?
  isActive          Boolean   @default(true)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  property          Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  apartment         Apartment? @relation(fields: [apartmentId], references: [id], onDelete: Cascade)
  
  @@unique([propertyId, apartmentId, effectiveFrom])
  @@index([propertyId])
  @@index([apartmentId])
  @@index([isActive])
}

// Notification System Models

model NotificationTemplate {
  id                String    @id @default(cuid())
  propertyId        String?   // null = system default
  
  // Template info
  name              String
  code              String    @unique
  notificationType  NotificationType
  channel           NotificationChannel
  
  // Template content
  subject           String
  body              String    // HTML/Markdown content
  variables         Json?     // Variables used: {tenantName}, {invoiceAmount}, etc.
  
  // Status & Versions
  isActive          Boolean   @default(true)
  version           Int       @default(1)
  createdBy         String
  updatedBy         String?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  property          Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  createdByUser     User      @relation("TemplateCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  updatedByUser     User?     @relation("TemplateUpdater", fields: [updatedBy], references: [id], onDelete: SetNull)
  
  @@index([propertyId])
  @@index([notificationType])
  @@index([channel])
  @@index([isActive])
}

model NotificationPreference {
  id                String    @id @default(cuid())
  userId            String
  
  // Channel preferences
  emailEnabled      Boolean   @default(true)
  smsEnabled        Boolean   @default(true)
  pushEnabled       Boolean   @default(true)
  inAppEnabled      Boolean   @default(true)
  whatsappEnabled   Boolean   @default(false)
  
  // Notification type preferences
  invoiceNotifications    Boolean @default(true)
  paymentNotifications    Boolean @default(true)
  maintenanceNotifications Boolean @default(true)
  broadcastNotifications  Boolean @default(true)
  emergencyNotifications  Boolean @default(true)
  systemNotifications     Boolean @default(true)
  
  // Timing preferences
  quietHourStart    Int?
  quietHourEnd      Int?
  doNotDisturbEnabled Boolean @default(false)
  
  // Email settings
  weeklyDigest      Boolean   @default(false)
  dailyDigest       Boolean   @default(false)
  instantNotifications Boolean @default(true)
  
  // SMS settings
  smsFrequency      String    @default("immediate")
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId])
  @@index([userId])
}

model Notification {
  id                String    @id @default(cuid())
  propertyId        String?
  
  // Recipient targeting
  recipientType     String    @default("individual")
  recipientIds      String[]
  targetFloors      String[]
  targetApartments  String[]
  
  // Notification content
  notificationType  NotificationType
  subject           String
  body              String
  htmlBody          String?
  
  // Template reference
  templateId        String?
  templateVariables Json?
  
  // Channels
  channels          NotificationChannel[]
  
  // Status
  status            NotificationStatus @default(DRAFT)
  scheduledFor      DateTime?
  sentAt            DateTime?
  
  // Tracking
  totalRecipients   Int       @default(0)
  sentCount         Int       @default(0)
  deliveredCount    Int       @default(0)
  failedCount       Int       @default(0)
  openedCount       Int       @default(0)
  clickedCount      Int       @default(0)
  
  // Retry settings
  retryAttempts     Int       @default(0)
  maxRetries        Int       @default(3)
  nextRetryAt       DateTime?
  
  // Metadata
  priority          String    @default("normal")
  expiresAt         DateTime?
  createdBy         String
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  property          Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  template          NotificationTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  createdByUser     User      @relation(fields: [createdBy], references: [id], onDelete: Restrict)
  deliveries        NotificationDelivery[]
  
  @@index([propertyId])
  @@index([status])
  @@index([scheduledFor])
  @@index([createdBy])
  @@index([priority])
}

model NotificationDelivery {
  id                String    @id @default(cuid())
  notificationId    String
  recipientId       String
  
  // Delivery info
  channel           NotificationChannel
  destination       String
  
  // Status
  status            NotificationDeliveryStatus @default(PENDING)
  sentAt            DateTime?
  deliveredAt       DateTime?
  failedAt          DateTime?
  bouncedAt         DateTime?
  
  // Tracking
  openedAt          DateTime?
  clickedAt         DateTime?
  openCount        Int       @default(0)
  clickCount       Int       @default(0)
  
  // Error handling
  errorCode         String?
  errorMessage      String?
  retryCount        Int       @default(0)
  nextRetryAt       DateTime?
  
  // Device info
  deviceId          String?
  deviceType        String?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  notification      Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  recipient         User      @relation(fields: [recipientId], references: [id], onDelete: Cascade)
  
  @@unique([notificationId, recipientId, channel])
  @@index([notificationId])
  @@index([recipientId])
  @@index([status])
  @@index([channel])
  @@index([sentAt])
}

model NotificationLog {
  id                String    @id @default(cuid())
  notificationId    String?
  deliveryId        String?
  
  event             String
  channel           String
  recipient         String?
  
  success           Boolean
  errorCode         String?
  errorMessage      String?
  
  metadata          Json?
  
  createdAt         DateTime  @default(now())
  
  @@index([notificationId])
  @@index([deliveryId])
  @@index([event])
  @@index([createdAt])
}

model BroadcastMessage {
  id                String    @id @default(cuid())
  propertyId        String
  
  title             String
  message           String
  htmlMessage       String?
  
  targetAudience    String    @default("all")
  targetFloors      String[]
  targetApartments  String[]
  excludeUsers      String[]
  
  channels          NotificationChannel[]
  
  isActive          Boolean   @default(true)
  scheduledAt       DateTime?
  sentAt            DateTime?
  expiresAt         DateTime?
  
  viewCount         Int       @default(0)
  engagementRate    Float     @default(0)
  
  createdBy         String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  property          Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  createdByUser     User      @relation(fields: [createdBy], references: [id], onDelete: Restrict)
  
  @@index([propertyId])
  @@index([isActive])
  @@index([sentAt])
}

model InAppNotification {
  id                String    @id @default(cuid())
  userId            String
  
  title             String
  message           String
  icon              String?
  actionUrl         String?
  
  isRead            Boolean   @default(false)
  readAt            DateTime?
  isArchived        Boolean   @default(false)
  archivedAt        DateTime?
  
  type              NotificationType
  priority          String    @default("normal")
  relatedId         String?
  
  expiresAt         DateTime?
  createdAt         DateTime  @default(now())
  
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([type])
}

model PushDeviceToken {
  id                String    @id @default(cuid())
  userId            String
  
  token             String
  deviceId          String    @unique
  deviceType        String
  deviceModel       String?
  osVersion        String?
  appVersion        String?
  
  isActive          Boolean   @default(true)
  isVerified        Boolean   @default(false)
  verifiedAt        DateTime?
  
  lastUsedAt        DateTime?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, deviceId])
  @@index([userId])
  @@index([isActive])
  @@index([deviceType])
}

model NotificationSchedule {
  id                String    @id @default(cuid())
  propertyId        String?
  
  name              String
  description       String?
  
  triggerEvent      String
  triggerCondition  Json?
  
  delayMinutes      Int?
  scheduleTime      String?
  daysOfWeek        Int[]
  
  notificationType  NotificationType
  channels          NotificationChannel[]
  templateId        String?
  
  isActive          Boolean   @default(true)
  lastTriggeredAt   DateTime?
  
  createdBy         String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  property          Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  template          NotificationTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  createdByUser     User      @relation(fields: [createdBy], references: [id], onDelete: Restrict)
  
  @@index([propertyId])
  @@index([isActive])
  @@index([triggerEvent])
}
